import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot } from 'firebase/firestore';

// Hardcoded CSV data for the essay template and exemplar
// This ensures the application is self-contained and fully functional.
const TEMPLATE_DATA = {
    introduction: [
        "Define the Issue",
        "Establish the significance",
        "State your thesis"
    ],
    body_1: [
        "Transition 1.1",
        "First Reason (TS)",
        "Transition 1.2",
        "Counter-claim 1.1",
        "Transition 1.3",
        "Evidence 1.1",
        "Transition 1.4",
        "Rebuttal / Claim 1.1",
        "Evidence 1.2",
        "Elaboration 1.1",
        "Transition 1.5",
        "Claim 1.2",
        "Transition 1.6",
        "Evidence 1.3",
        "Elaboration, Link 1.1"
    ],
    body_2: [
        "Transition 2.1",
        "Second Reason (TS)",
        "Transition 2.2",
        "Counter-claim 2.1",
        "Evidence 2.1",
        "Transition 2.3",
        "Rebuttal / Claim 2.1",
        "Transition 2.4",
        "Evidence 2.2",
        "Elaboration, Link 2.1",
        "Claim 2.2",
        "Transition 2.5",
        "Evidence 2.3",
        "Elaboration, Link 2.2"
    ],
    body_3: [
        "Transition 3.1",
        "Third Reason (TS)",
        "Transition 3.2",
        "Counter-claim 3.1",
        "Evidence 3.1",
        "Rebuttal / Claim 3.1",
        "Evidence 3.2",
        "Elaboration, Link 3.1",
        "Claim 3.2",
        "Evidence 3.3",
        "Elaboration, Link 3.2"
    ],
    conclusion: [
        "Restate thesis",
        "Review reasons",
        "Call to action"
    ]
};

const EXEMPLAR_DATA = {
    introduction: [
        "Countless scientists and nature-lovers have the same item on their bucket lists: a visit to the Galapagos Islands. The environmental preserve made famous by Charles Darwin attracts loads of visitors every year.",
        "While this can be great for education and tourism, it puts the sensitive ecosystem at risk.",
        "That is why, even though it offers some local and global benefits, Galapagos tourism should be discouraged because of the severe risks it poses to the environment."
    ],
    body_1: [
        "One risk posed by Galapagos tourism",
        "is the degradation of the physical environment.",
        "It is often argued that ",
        "tourism provides the needed financial support to support and protect and maintain this ecosystem.",
        "Indeed, as passage one states, ",
        "\"tourism in Ecuador ... generates $1.2 billion per year.\"",
        "While this money is undoubtedly useful,",
        "it has stimulated unregulated growth that is polluting a formerly peaceful environment:",
        "“It’s unsustainable. More flights, more hotels, more cars. It's uncontrolled. We talk about ecotourism but in reality it's already showing signs of being mass tourism\" (Passage 2).",
        "Governments and businesses seek growth, so it is natural that a profitable tourist venture will lose sight of its environmental purpose and start to neglect conservation in favor of profit.",
        "What’s more,",
        "the presence of a large human population is harmful to the delicate local flora and fauna.",
        "A constant stream of visitors introduces \"unnatural stressors\" to the wildlife (Passage One).",
        "This is an unacceptable side effect for a place whose entire purpose is the preservation of its natural environment."
    ],
    body_2: [
        "A second problem with tourism on the islands",
        "is the disruption of natural ecosystems.",
        "Proponents of tourism insist that",
        "these educational opportunities are beneficial and promote preservation.",
        "After all, Passage Two makes it clear that",
        "the Galápagos Islands can send visitors home with a \"renewed passion for the preservation of wildlife\" (Passage One).",
        "However,",
        "such passionate feelings about the environment are only useful if the environment is still there to be preserved. ",
        "The current tourist numbers are already causing massive disruptions to the delicate balance of the Galápagos Islands: \"The Islands' ecosystem is not coping with the number of tourists\" (Passage Two).",
        "Additionally, the massive tourist influx ",
        "has caused the introduction of “non-native plants and animals”",
        "that have wreaked havoc on the native species and their food sources (Passage Two).",
        "In short, the high tourist numbers are undoing the very educational benefits that tourism is supposed to create."
    ],
    body_3: [
        "A final problem with tourism is that",
        "it has become more about personal enrichment than about education.",
        "While it is true that",
        "the Galápagos Islands can send visitors home with a \"renewed passion for the preservation of wildlife\" (Passage One).",
        "Education is a noble goal, but the massive number of visitors is evidence that more than just conservationists are making this trip:",
        "“We talk about ecotourism, but…People aren't even coming for the wildlife any more. They just come for a vacation” (Passage Two).",
        "This change in public translates to changes in behaviors.",
        "Now people want to swim with the seals and pose for photos,",
        "reducing “a pristine natural environment” to a mere “place where tourists take ‘selfies’ with giant tortoises” (Passage Two).",
        "If the Galapagos Islands are serious about promoting environmental preservation, they need to make this destination more about science and less about likes."
    ],
    conclusion: [
        "It can clearly be seen that tourism to the Galapagos Islands has become unsustainable and dangerous.",
        "The massive number of visitors poses a threat to plants and animals, and has made the destination more about vacation than conservation.",
        "The economic and educational benefits are still worthwhile, so the most sensible solution would be to impose limits that allow true ecotourism to continue while better protecting the environment. Otherwise, there will be nothing left for visitors to see on these special Ecuadorian islands."
    ]
};

// Paragraph order for navigation
const PARAGRAPH_KEYS = ['introduction', 'body_1', 'body_2', 'body_3', 'conclusion'];

// Main Application Component
const App = () => {
    const [paragraphIndex, setParagraphIndex] = useState(0);
    const [essayData, setEssayData] = useState({});
    const [showFinalEssay, setShowFinalEssay] = useState(false);
    const [firebaseReady, setFirebaseReady] = useState(false);
    const [db, setDb] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isSaving, setIsSaving] = useState(false);

    // Initialize Firebase and set up auth listener
    useEffect(() => {
        try {
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const firestore = getFirestore(app);
            setDb(firestore);

            // Sign in anonymously or with custom token
            const authStateListener = onAuthStateChanged(auth, async (user) => {
                if (user) {
                    setUserId(user.uid);
                    setFirebaseReady(true);
                } else {
                    const tempUserId = crypto.randomUUID();
                    setUserId(tempUserId);
                    try {
                        const __initial_auth_token = typeof window !== 'undefined' && window.__initial_auth_token;
                        if (__initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth error:", error);
                        // If auth fails, proceed without persistence
                        setFirebaseReady(true);
                    }
                }
            });

            return () => authStateListener();
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            // Fallback to non-persistent mode if Firebase fails
            setFirebaseReady(true);
        }
    }, []);

    // Load and save data from Firestore
    useEffect(() => {
        if (!firebaseReady || !userId) return;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'essays', 'draft');

        // Listen for real-time changes
        const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const loadedData = docSnap.data();
                setEssayData(loadedData.content || {});
            }
        }, (error) => {
            console.error("Error listening to Firestore:", error);
            // Handle error, but don't break the app
        });

        // Save data to Firestore on state change
        const saveTimeout = setTimeout(() => {
            if (!isSaving && Object.keys(essayData).length > 0) {
                setIsSaving(true);
                setDoc(userDocRef, { content: essayData, lastUpdated: new Date() })
                    .then(() => setIsSaving(false))
                    .catch((error) => {
                        console.error("Error saving to Firestore:", error);
                        setIsSaving(false);
                    });
            }
        }, 1000); // Debounce save to 1 second

        return () => {
            unsubscribe();
            clearTimeout(saveTimeout);
        };
    }, [essayData, db, userId, firebaseReady]);

    // Handle input change for a specific prompt
    const handleInputChange = (paragraphKey, promptIndex, value) => {
        setEssayData(prevData => {
            const newParagraphData = prevData[paragraphKey] ? [...prevData[paragraphKey]] : new Array(TEMPLATE_DATA[paragraphKey].length).fill('');
            newParagraphData[promptIndex] = value;
            return {
                ...prevData,
                [paragraphKey]: newParagraphData
            };
        });
    };

    // Concatenate all parts to form the final essay
    const getFinalEssay = () => {
        let essayText = "";
        PARAGRAPH_KEYS.forEach(key => {
            if (essayData[key]) {
                essayText += essayData[key].join(' ') + '\n\n';
            }
        });
        return essayText.trim();
    };

    const paragraphs = Object.keys(TEMPLATE_DATA);
    const currentParagraphKey = PARAGRAPH_KEYS[paragraphIndex];

    const isLastParagraph = paragraphIndex === paragraphs.length - 1;

    return (
        <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
            <div className="bg-white shadow-xl rounded-2xl p-6 sm:p-8 w-full max-w-4xl">
                <h1 className="text-3xl font-bold text-center text-gray-800 mb-6">
                    Argumentative Essay Builder
                </h1>
                <p className="text-center text-gray-600 mb-8">
                    Follow the prompts below to build your essay step-by-step.
                    Your work is automatically saved.
                </p>

                {/* Loading State for Firestore */}
                {!firebaseReady && (
                    <div className="text-center text-gray-500 mb-4">
                        <div className="animate-spin inline-block w-6 h-6 border-4 border-dashed rounded-full border-blue-500 border-t-transparent"></div>
                        <p className="mt-2">Connecting to storage...</p>
                    </div>
                )}
                
                {/* User ID for persistence and sharing */}
                {userId && (
                    <div className="text-center text-gray-500 text-sm mb-6">
                        <span className="font-semibold">Your Session ID:</span> {userId}
                    </div>
                )}

                {showFinalEssay ? (
                    <FinalEssay
                        essayText={getFinalEssay()}
                        onBack={() => setShowFinalEssay(false)}
                    />
                ) : (
                    <>
                        <ParagraphForm
                            paragraphKey={currentParagraphKey}
                            templatePrompts={TEMPLATE_DATA[currentParagraphKey]}
                            exemplarExamples={EXEMPLAR_DATA[currentParagraphKey]}
                            essayData={essayData[currentParagraphKey] || []}
                            onInputChange={handleInputChange}
                        />

                        {/* Navigation Buttons */}
                        <div className="flex flex-col sm:flex-row justify-between items-center mt-8 space-y-4 sm:space-y-0 sm:space-x-4">
                            <button
                                onClick={() => setParagraphIndex(prev => prev - 1)}
                                disabled={paragraphIndex === 0}
                                className="w-full sm:w-auto px-6 py-3 bg-gray-200 text-gray-700 rounded-lg shadow-md hover:bg-gray-300 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                Previous
                            </button>
                            {isLastParagraph ? (
                                <button
                                    onClick={() => setShowFinalEssay(true)}
                                    className="w-full sm:w-auto px-6 py-3 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition-colors duration-200"
                                >
                                    Generate Final Essay
                                </button>
                            ) : (
                                <button
                                    onClick={() => setParagraphIndex(prev => prev + 1)}
                                    className="w-full sm:w-auto px-6 py-3 bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600 transition-colors duration-200"
                                >
                                    Next Paragraph
                                </button>
                            )}
                        </div>
                    </>
                )}
            </div>
        </div>
    );
};

// Component for a single paragraph form
const ParagraphForm = ({ paragraphKey, templatePrompts, exemplarExamples, essayData, onInputChange }) => {
    return (
        <div className="space-y-6">
            <h2 className="text-2xl font-semibold text-gray-700 capitalize text-center mb-6">
                {paragraphKey.replace('_', ' ')}
            </h2>
            {templatePrompts.map((prompt, index) => (
                <div key={index} className="bg-gray-100 p-4 rounded-lg shadow-inner">
                    <label className="block text-gray-700 font-medium mb-2">
                        {prompt}
                    </label>
                    <textarea
                        className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200"
                        rows="3"
                        value={essayData[index] || ''}
                        onChange={(e) => onInputChange(paragraphKey, index, e.target.value)}
                        placeholder={`Enter your text for "${prompt}" here...`}
                    />
                    <details className="mt-2 text-sm text-gray-500 cursor-pointer">
                        <summary className="font-semibold hover:text-blue-600 transition-colors duration-200">
                            See Example
                        </summary>
                        <p className="mt-1 p-2 bg-gray-200 rounded-md whitespace-pre-wrap">
                            {exemplarExamples[index]}
                        </p>
                    </details>
                </div>
            ))}
        </div>
    );
};

// Component to display the final essay
const FinalEssay = ({ essayText, onBack }) => {
    const [message, setMessage] = useState('');

    // Copy the essay text to the clipboard
    const copyToClipboard = () => {
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = essayText;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        try {
            document.execCommand('copy');
            setMessage('Essay copied to clipboard!');
        } catch (err) {
            setMessage('Failed to copy. Please copy manually.');
            console.error('Copy to clipboard failed:', err);
        }
        document.body.removeChild(tempTextArea);
        setTimeout(() => setMessage(''), 3000);
    };

    return (
        <div className="space-y-6">
            <h2 className="text-2xl font-semibold text-gray-700 text-center">Your Final Essay</h2>
            <div className="bg-gray-100 p-6 rounded-lg shadow-inner whitespace-pre-wrap leading-relaxed border border-gray-300">
                {essayText || "Your essay will appear here once you've completed all the sections."}
            </div>
            {message && (
                <div className="text-center text-sm font-semibold text-green-600">
                    {message}
                </div>
            )}
            <div className="flex flex-col sm:flex-row justify-center items-center gap-4 mt-6">
                <button
                    onClick={copyToClipboard}
                    className="w-full sm:w-auto px-6 py-3 bg-teal-500 text-white font-bold rounded-lg shadow-md hover:bg-teal-600 transition-colors duration-200"
                    disabled={!essayText}
                >
                    Copy to Clipboard
                </button>
                <button
                    onClick={onBack}
                    className="w-full sm:w-auto px-6 py-3 bg-gray-200 text-gray-700 rounded-lg shadow-md hover:bg-gray-300 transition-colors duration-200"
                >
                    Go Back and Edit
                </button>
            </div>
        </div>
    );
};

export default App;
